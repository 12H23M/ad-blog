---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';
import '../styles/global.css';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    pubDate: string;
    category: 'culture' | 'food' | 'travel' | 'lifestyle' | 'language';
    shortId: string;
    keywords?: string;
  };
}

const { frontmatter } = Astro.props;
const { title, description, pubDate, category, shortId, keywords } = frontmatter;

const categoryNames: Record<string, string> = {
  'culture': 'Culture',
  'food': 'Food',
  'travel': 'Travel',
  'lifestyle': 'Lifestyle',
  'language': 'Language'
};
const categoryDisplayName = categoryNames[category] || category;

const formattedDate = new Date(pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const currentPath = Astro.url.pathname;

// 관련 글 가져오기 (같은 카테고리 또는 최신 글)
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(post => post.data.shortId !== shortId)
  .sort((a, b) => {
    // 같은 카테고리 우선
    if (a.data.category === category && b.data.category !== category) return -1;
    if (b.data.category === category && a.data.category !== category) return 1;
    // 날짜순
    return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
  })
  .slice(0, 3);

const siteUrl = 'https://baksuls.com';
const canonicalUrl = `${siteUrl}/${category}/${shortId}`;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- SEO Meta Tags -->
    <title>{title} | Baksuls Blog</title>
    <meta name="description" content={description}>
    {keywords && <meta name="keywords" content={keywords}>}
    <link rel="canonical" href={canonicalUrl}>
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">

    <!-- Open Graph -->
    <meta property="og:title" content={title}>
    <meta property="og:description" content={description}>
    <meta property="og:type" content="article">
    <meta property="og:url" content={canonicalUrl}>
    <meta property="og:site_name" content="Baksuls Blog">
    <meta property="og:locale" content="en_US">
    <meta property="article:published_time" content={pubDate}>
    <meta property="article:section" content={categoryDisplayName}>

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content={title}>
    <meta name="twitter:description" content={description}>

    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": title,
        "description": description,
        "datePublished": pubDate,
        "dateModified": pubDate,
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": canonicalUrl
        },
        "author": {
            "@type": "Person",
            "name": "Baksuls Blog"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Baksuls Blog"
        },
        "articleSection": categoryDisplayName
    })} />

    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": siteUrl
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": categoryDisplayName,
                "item": `${siteUrl}/${category}`
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": title,
                "item": canonicalUrl
            }
        ]
    })} />
</head>
<body>
    <Header currentPath={currentPath} />

    <main class="main-content">
        <article class="post" itemscope itemtype="https://schema.org/Article">
            <header class="post-header">
                <h1 class="post-title" itemprop="headline">{title}</h1>
                <div class="post-meta">
                    <time datetime={pubDate} itemprop="datePublished">{formattedDate}</time>
                    <span class="category" itemprop="articleSection">{categoryDisplayName}</span>
                </div>
            </header>

            <div class="post-content" itemprop="articleBody">
                <slot />
            </div>

            {relatedPosts.length > 0 && (
                <aside class="related-posts">
                    <h3>Related Posts</h3>
                    <ul>
                        {relatedPosts.map((post) => (
                            <li>
                                <a href={`/${post.data.category}/${post.data.shortId}`}>{post.data.title}</a>
                            </li>
                        ))}
                    </ul>
                </aside>
            )}
        </article>
    </main>

    <Footer />
</body>
</html>
