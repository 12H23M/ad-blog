---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import TOC from '../components/TOC.astro';
import SeriesNav from '../components/SeriesNav.astro';
import CategoryBadge from '../components/CategoryBadge.astro';
import { getCollection } from 'astro:content';
import '../styles/global.css';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    pubDate: string;
    lang: 'ko' | 'en';
    category: string;
    series?: string;
    seriesOrder?: number;
    translationOf?: string;
    tags: string[];
    draft: boolean;
  };
  headings: { depth: number; slug: string; text: string }[];
  slug: string;
  rawContent: string;
}

const { frontmatter, headings, slug, rawContent } = Astro.props;
const { title, description, pubDate, lang, category, series, seriesOrder, translationOf, tags } = frontmatter;

const currentPath = Astro.url.pathname;
const siteUrl = 'https://baksuls.com';
const canonicalUrl = `${siteUrl}/blog/${slug}`;

// Reading time
const words = rawContent?.split(/\s+/).length ?? 0;
const readingTime = Math.max(1, Math.ceil(words / 200));
const readingLabel = lang === 'ko' ? `${readingTime}분 소요` : `${readingTime} min read`;

// Date formatting
function formatDate(dateStr: string, lng: string): string {
  const date = new Date(dateStr);
  if (lng === 'ko') return `${date.getFullYear()}. ${date.getMonth() + 1}. ${date.getDate()}.`;
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

// All posts for related/series
const allPosts = await getCollection('posts');
const publishedPosts = allPosts.filter(p => !p.data.draft);

// Translation link
const translationPost = translationOf
  ? publishedPosts.find(p => p.id === translationOf)
  : null;

const translationLabel = lang === 'ko' ? 'English version available' : '한국어 버전 보기';

// Series navigation
let seriesPrev = null;
let seriesNext = null;
if (series && seriesOrder !== undefined) {
  const seriesPosts = publishedPosts
    .filter(p => p.data.series === series)
    .sort((a, b) => (a.data.seriesOrder ?? 0) - (b.data.seriesOrder ?? 0));
  const currentIdx = seriesPosts.findIndex(p => p.id === slug);
  if (currentIdx > 0) {
    const prev = seriesPosts[currentIdx - 1];
    seriesPrev = { slug: prev.id, title: prev.data.title };
  }
  if (currentIdx >= 0 && currentIdx < seriesPosts.length - 1) {
    const next = seriesPosts[currentIdx + 1];
    seriesNext = { slug: next.id, title: next.data.title };
  }
}

// Related posts
const relatedPosts = publishedPosts
  .filter(p => p.id !== slug)
  .sort((a, b) => {
    if (a.data.category === category && b.data.category !== category) return -1;
    if (b.data.category === category && a.data.category !== category) return 1;
    return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
  })
  .slice(0, 3);

// hreflang
const hreflangUrl = translationPost ? `${siteUrl}/blog/${translationPost.id}` : null;
const hreflangLang = lang === 'ko' ? 'en' : 'ko';
---

<!DOCTYPE html>
<html lang={lang}>
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5D4D6ZFH');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- SEO -->
    <title>{title} | TradeLog.dev</title>
    <meta name="description" content={description}>
    <link rel="canonical" href={canonicalUrl}>
    <meta name="robots" content="index, follow">

    {hreflangUrl && <link rel="alternate" hreflang={hreflangLang} href={hreflangUrl} />}
    <link rel="alternate" hreflang={lang} href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:title" content={title}>
    <meta property="og:description" content={description}>
    <meta property="og:type" content="article">
    <meta property="og:url" content={canonicalUrl}>
    <meta property="og:site_name" content="TradeLog.dev">
    <meta property="og:locale" content={lang === 'ko' ? 'ko_KR' : 'en_US'}>
    <meta property="article:published_time" content={pubDate}>
    {tags.map(tag => <meta property="article:tag" content={tag} />)}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content={title}>
    <meta name="twitter:description" content={description}>

    <!-- JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": title,
        "description": description,
        "datePublished": pubDate,
        "dateModified": pubDate,
        "inLanguage": lang,
        "mainEntityOfPage": { "@type": "WebPage", "@id": canonicalUrl },
        "author": { "@type": "Organization", "name": "TradeLog.dev" },
        "publisher": { "@type": "Organization", "name": "TradeLog.dev" },
    })} />

    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": siteUrl },
            { "@type": "ListItem", "position": 2, "name": "Blog", "item": `${siteUrl}/blog` },
            { "@type": "ListItem", "position": 3, "name": title, "item": canonicalUrl },
        ]
    })} />

    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-3610279445330236">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3610279445330236"
     crossorigin="anonymous"></script>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5D4D6ZFH"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <div class="reading-progress" id="reading-progress"></div>

    <Header currentPath={currentPath} lang={lang} />

    <main class="main-content">
      <article class="post-article" itemscope itemtype="https://schema.org/Article">
        {translationPost && (
          <a href={`/blog/${translationPost.id}`} class="post-translation-link">
            {translationLabel}
          </a>
        )}

        <header class="post-header">
          <div class="post-meta">
            <CategoryBadge category={category} lang={lang} />
            <span>{formatDate(pubDate, lang)}</span>
            <span>&middot;</span>
            <span>{readingLabel}</span>
          </div>
          <h1 class="post-title" itemprop="headline">{title}</h1>
        </header>

        <TOC headings={headings} lang={lang} />

        <div class="post-content" itemprop="articleBody">
          <slot />
        </div>

        {(seriesPrev || seriesNext) && (
          <SeriesNav prev={seriesPrev} next={seriesNext} lang={lang} />
        )}

        {relatedPosts.length > 0 && (
          <aside class="related-posts">
            <h3>{lang === 'ko' ? '관련 포스트' : 'Related Posts'}</h3>
            <div class="related-posts-list">
              {relatedPosts.map((post) => (
                <a href={`/blog/${post.id}`}>{post.data.title}</a>
              ))}
            </div>
          </aside>
        )}
      </article>
    </main>

    <Footer lang={lang} />

    <button class="back-to-top" id="back-to-top" aria-label="Back to top">&uarr;</button>

    <script>
      function initPostPage() {
        // Code block: wrap with copy button + language label
        document.querySelectorAll('.post-content pre').forEach((pre) => {
          if (pre.closest('.code-block-wrapper')) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';

          // Language label
          const code = pre.querySelector('code');
          if (code) {
            const langClass = Array.from(code.classList).find(c => c.startsWith('language-'));
            if (langClass) {
              const langName = langClass.replace('language-', '');
              const label = document.createElement('span');
              label.className = 'code-lang-label';
              label.textContent = langName;
              wrapper.appendChild(label);
            }
          }

          // Copy button
          const btn = document.createElement('button');
          btn.className = 'copy-btn';
          btn.textContent = 'Copy';
          btn.addEventListener('click', async () => {
            const codeEl = pre.querySelector('code');
            if (!codeEl) return;
            try {
              await navigator.clipboard.writeText(codeEl.textContent || '');
              btn.textContent = 'Copied!';
              btn.classList.add('copied');
              setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
            } catch { btn.textContent = 'Failed'; }
          });

          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(btn);
          wrapper.appendChild(pre);
        });

        // Reading progress bar
        const progressBar = document.getElementById('reading-progress');
        const article = document.querySelector('.post-article');
        if (progressBar && article) {
          const updateProgress = () => {
            const rect = article.getBoundingClientRect();
            const articleTop = rect.top + window.scrollY;
            const articleHeight = rect.height;
            const scrolled = window.scrollY - articleTop;
            const progress = Math.min(100, Math.max(0, (scrolled / (articleHeight - window.innerHeight)) * 100));
            progressBar.style.width = progress + '%';
          };
          window.addEventListener('scroll', updateProgress, { passive: true });
          updateProgress();
        }

        // Back to top button
        const backToTop = document.getElementById('back-to-top');
        if (backToTop) {
          const toggleBtn = () => {
            backToTop.classList.toggle('visible', window.scrollY > 400);
          };
          window.addEventListener('scroll', toggleBtn, { passive: true });
          toggleBtn();
          backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        }
      }
      document.addEventListener('astro:page-load', initPostPage);
      document.addEventListener('DOMContentLoaded', initPostPage);
    </script>
</body>
</html>
